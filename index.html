<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>115 tools</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body x-data="{ 
    stats: {
        sync: { completed: 0, total: 0, running: false, errors: [] },
        strm: { completed: 0, total: 0, running: false, errors: [] }
    },
    get syncPercent() { return Math.round((this.stats.sync.completed / this.stats.sync.total) * 100)},
    get strmPercent() { return Math.round((this.stats.strm.completed / this.stats.strm.total) * 100)},
    get allErrors() { 
        return [
            ...(this.stats.sync.errors || []), 
            ...(this.stats.strm.errors || [])
        ] 
    }
}" x-init="
    const es = new EventSource('/logs');
    es.onmessage = (e) => { stats = JSON.parse(e.data);};
">
    <main class="container">

        <div class="grid">
            <article>
                <header>文件同步</header>
                <fieldset role="group">
                    <h2>
                        <span x-text="stats.sync.completed">0</span> / <span x-text="stats.sync.total">0</span>
                    </h2>
                    <button @click="fetch(stats.sync.running ? '/stopsync' : '/sync')"
                        :class="stats.sync.running ? 'secondary' : ''" x-text="stats.sync.running ? '停止' : '开始'">
                    </button>
                </fieldset>
                <progress :value="stats.sync.running ? syncPercent : -1" max="100"></progress>
            </article>

            <article>
                <header>STRM 生成</header>
                <fieldset role="group">
                    <h2>
                        <span x-text="stats.strm.completed">0</span> / <span x-text="stats.strm.total">0</span>
                    </h2>
                    <button @click="fetch(stats.strm.running ? '/stopstrm' : '/strm')"
                        :class="stats.strm.running ? 'secondary' : ''" x-text="stats.strm.running ? '停止' : '开始'">
                    </button>
                </fieldset>
                <progress :value="stats.strm.running ? strmPercent : -1" max="100"></progress>
            </article>
        </div>

        <details :open="allErrors.length > 0">
            <summary role="button" class="outline secondary">错误日志</summary>
            <div class="overflow-auto" style="max-height: 150px;">
                <table class="striped">
                    <template x-for="err in allErrors">
                        <tr>
                            <td x-text="err"></td>
                        </tr>
                    </template>
                </table>
            </div>
        </details>
    </main>
</body>

</html>