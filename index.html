<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link id="favicon" rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='1em' font-size='80'>☁️</text></svg>">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body x-data="{ 
    stats: {
        sync: { completed: 0, total: 0, running: false, errors: [] },
        strm: { completed: 0, total: 0, running: false, errors: [] }
    },
    get syncPercent() {
        if (this.stats.sync.total === 0) return 0;
        return Math.round((this.stats.sync.completed / this.stats.sync.total) * 100)
    },
    get strmPercent() {
        if (this.stats.strm.total === 0) return 0;
        return Math.round((this.stats.strm.completed / this.stats.strm.total) * 100)
    },
    get allErrors() { return [...this.stats.sync.errors, ...this.stats.strm.errors]}
}" x-init="
    const es = new EventSource('/logs');
    es.onmessage = (e) => { stats = JSON.parse(e.data) };
">
    <main class="container">
        <div class="grid">
            <article x-data="{ r: () => stats.sync.running }">
                <header>文件同步</header>
                <fieldset role="group">
                    <h2 style="margin: 0; flex: 1;align-content: center;"><span x-text="stats.sync.completed">0</span> / <span
                            x-text="stats.sync.total">0</span></h2>
                    <button @click="fetch(r() ? '/stopsync' : '/sync');stats.sync.running = !stats.sync.running;" :class="r() ? 'secondary' : ''"
                        x-text="r() ? '停止' : '开始'"></button>
                </fieldset>
                <progress x-show="r()" :value="syncPercent" max="100"></progress>
            </article>

            <article x-data="{ r: () => stats.strm.running }">
                <header>STRM 生成</header>
                <fieldset role="group">
                    <h2 style="margin: 0; flex: 1;align-content: center;"><span x-text="stats.strm.completed">0</span> / <span
                            x-text="stats.strm.total">0</span></h2>
                    <button @click="fetch(r() ? '/stopstrm' : '/strm');stats.strm.running = !stats.strm.running;" :class="r() ? 'secondary' : ''"
                        x-text="r() ? '停止' : '开始'"></button>
                </fieldset>
                <progress x-show="r()" :value="strmPercent" max="100"></progress>
            </article>
        </div>

        <details :open="allErrors.length > 0">
            <summary role="button" class="outline secondary">错误日志 <span x-show="allErrors.length"
                    x-text="'(' + allErrors.length + ')'"></span></summary>
            <div class="overflow-auto" style="max-height: 150px;">
                <table class="striped">
                    <template x-if="!allErrors.length">
                        <tr>
                            <td style="text-align:center"><small>暂无日志</small></td>
                        </tr>
                    </template>
                    <template x-for="err in allErrors">
                        <tr>
                            <td x-text="err" style="color:var(--pico-del-color);font-size:0.8rem"></td>
                        </tr>
                    </template>
                </table>
            </div>
        </details>
    </main>
</body>

</html>